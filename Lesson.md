# 项目经验记录

## 项目技术栈
- Node.js + Express 作为Web服务框架
- Multer 用于处理文件上传（v1.4.5-lts.1）
- Axios 用于获取远程图片（v1.6.7）
- Sharp 用于图像处理（v0.33.4）
- Blurhash 用于生成图片编码（v2.0.5）

## 最佳实践
1. **图像处理**
   - 使用Sharp调整图片尺寸至32x32可以大幅提高Blurhash计算效率
   - 处理图片时应确保Alpha通道，使用ensureAlpha()方法
   - 支持自定义组件参数(componentX, componentY)可以调整编码质量和大小

2. **文件处理**
   - 上传临时文件应及时清理，避免磁盘空间浪费
   - 上传目录应在应用启动时确保存在，避免运行时错误
   - 使用multer的fileFilter可以在上传时就过滤非图片文件

3. **API设计**
   - 提供多种获取Blurhash的方式（文件上传和URL）增加了灵活性
   - 响应格式应统一，便于前端处理
   - 批处理API可以提高多图处理效率
   - 解码预览功能可以帮助用户理解和验证blurhash效果

4. **错误处理**
   - 应捕获并处理所有可能的异常，避免服务崩溃
   - 返回具体错误信息，帮助调试
   - 使用自定义错误类可以标准化错误处理流程
   - 区分生产和开发环境的错误信息详细程度
   - 处理未捕获的异常和Promise拒绝

5. **性能优化**
   - 缓存系统可显著减少重复计算
   - 使用哈希值作为缓存键可有效标识内容
   - 定期清理过期缓存避免内存泄漏
   - 批量请求使用Promise.all实现并行处理

6. **安全考虑**
   - 限制请求频率防止DoS攻击
   - 验证和过滤输入数据，特别是URL
   - 限制上传文件大小和类型
   - 添加安全相关HTTP头部
   - 远程资源获取设置超时和大小限制

7. **日志记录**
   - 结构化日志便于分析和搜索
   - 分离普通日志和错误日志
   - 记录关键操作和性能指标
   - 包含足够上下文信息便于调试

8. **代码架构**
   - MVC分层提高代码可维护性
   - 控制器专注业务逻辑，路由处理请求路径
   - 工具函数应独立且可复用
   - 中间件应专注于单一职责

## 优化经验
1. **从简单到复杂循序渐进**
   - 先实现基本功能，再添加高级特性
   - 先优化核心路径，再处理边缘情况

2. **测试与验证**
   - 每添加一个功能就进行测试
   - 考虑各种异常情况
   - 验证边界条件，如最大/最小值

3. **可维护性设计**
   - 模块化设计便于后续扩展
   - 良好的命名和注释提高可读性
   - 一致的代码风格和错误处理模式

4. **配置与环境分离**
   - 敏感信息应通过环境变量配置
   - 不同环境可能需要不同配置

## 潜在问题
1. 内存缓存在应用重启后会丢失，可考虑使用Redis等持久化缓存
2. 单进程模型在高并发下可能成为瓶颈，可考虑使用PM2等进程管理器
3. 文件上传安全性还可以进一步增强，如添加文件内容检测
4. 缺少健康检查和性能监控机制

## 改进方向
详见ProjectStatus.md中的遗留任务 